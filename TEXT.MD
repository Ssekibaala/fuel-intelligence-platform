

    XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX



    DECORD EVENTS


    let
    // ===================================================================
    // PART 0: BLOB STORAGE CONNECTION - CORRECTED
    // ===================================================================
    // Connect to the base URL of your storage account only.
    Source = AzureStorage.Blobs("https://onlineautomationstorage.blob.core.windows.net/"),
    
    // Access the 'rendalli' container's data.
    Container = Source{[Name="karma-regis"]}[Data],
    #"Filtered Rows" = Table.SelectRows(Container, each Text.StartsWith([Name], "events")),

    // Load and combine content of all JSON files.
    // Each JSON file is expected to contain a list of records (events) as generated by your Python script.
    CombinedContent = Table.AddColumn(#"Filtered Rows", "ParsedContent", each Json.Document([Content])),
    AllEvents = List.Combine(CombinedContent[ParsedContent]), // Combines all lists from all files into a single list
    EventsTable = Table.FromList(AllEvents, Splitter.SplitByNothing(), {"Record"}),
    #"Expanded Record" = Table.ExpandRecordColumn(EventsTable, "Record", {"car_id", "device_id", "message_id", "extra", "edt", "eid", "latitude", "longitude", "extra_parsed"}, {"car_id", "device_id", "message_id", "extra", "edt", "eid", "latitude", "longitude", "extra_parsed"}), 
    // ===================================================================
    // PART 1: DATA TRANSFORMATION (remains largely unchanged from your original code)
    // ===================================================================
    ExpandedExtra = Table.ExpandRecordColumn(#"Expanded Record", "extra_parsed", {"efuel"}),
    ExpandedFuel = Table.ExpandRecordColumn(ExpandedExtra, "efuel", {"message_type", "percent", "tank_size"}),
    // ===============================================================
    // TIME ZONE CONVERSION AND FINAL FORMATTING
    // ===============================================================
    #"Convert EDT to DateTime" = Table.TransformColumnTypes(ExpandedFuel, {{"edt", type datetime, "en-US"}}),
    #"Set EDT to UTC" = Table.TransformColumns(#"Convert EDT to DateTime", {
        {"edt", each DateTime.AddZone(_, 0), type datetimezone}
    }),
    #"Convert EDT to EAT" = Table.TransformColumns(#"Set EDT to UTC", {
        {"edt", each DateTimeZone.SwitchZone(_, 3), type datetimezone}
    }),
    #"Remove Timezone from EDT" = Table.TransformColumns(#"Convert EDT to EAT", {
        {"edt", each DateTimeZone.RemoveZone(_), type datetime} // Convert back to datetime
    }),
    #"Filtered Rows1" = Table.SelectRows(#"Remove Timezone from EDT", each ([car_id] <> 15885 and [car_id] <> 15886 and [car_id] <> 15887 and [car_id] <> 15888 and [car_id] <> 15939)),
    #"Appended Query" = Table.Combine({#"Filtered Rows1", Edata}),
    AddLiters = Table.AddColumn(#"Appended Query", "efuel.liters", each
        if [percent] <> null and [tank_size] <> null then ([percent] / 100) * [tank_size] else null),
    ChangedTypes = Table.TransformColumnTypes(AddLiters, {
        {"car_id", Int64.Type}
    }),
    // Step 4: Add indexes for fuel change detection
    Sorted = Table.Sort(ChangedTypes, {{"car_id", Order.Ascending}, {"edt", Order.Ascending}}),
    WithIndex = Table.AddIndexColumn(Sorted, "Index", 0, 1),
    PrevIndex = Table.AddColumn(WithIndex, "PrevIndex", each [Index] - 1),
    Joined = Table.NestedJoin(PrevIndex, {"PrevIndex"}, PrevIndex, {"Index"}, "PrevRow", JoinKind.LeftOuter),
    ExpandedPrev = Table.ExpandTableColumn(Joined, "PrevRow", {"car_id", "efuel.liters"}, {"prev.car_id", "prev.efuel.liters"}),

    // Step 5: Detect Fuel Events
    AddEventType = Table.AddColumn(ExpandedPrev, "Fuel Event Type", each
        if [car_id] = [prev.car_id] then
            let
                diff = [efuel.liters] - [prev.efuel.liters],
                // Assuming RefillPercentageThreshold and TheftPercentageThreshold are defined as parameters
                refill = RefillPercentageThreshold * [tank_size],
                theft = TheftPercentageThreshold * [tank_size]
            in
                if diff > refill then "Refill"
                else if diff < -theft then "Potential Theft"
                else "Normal"
        else "Normal"
    ),

    AddRefilled = Table.AddColumn(AddEventType, "Refilled Liters", each if [Fuel Event Type] = "Refill" then [efuel.liters] - [prev.efuel.liters] else 0),
    AddTheft = Table.AddColumn(AddRefilled, "Theft Liters", each if [Fuel Event Type] = "Potential Theft" then -([efuel.liters] - [prev.efuel.liters]) else 0),
    FinalClean = Table.RemoveColumns(AddTheft, {"Index", "PrevIndex", "prev.car_id", "prev.efuel.liters"}),
    #"Changed Type" = Table.TransformColumnTypes(FinalClean,{{"car_id", Int64.Type}, {"device_id", Int64.Type}, {"message_id", Int64.Type}, {"edt", type datetime}, {"eid", Int64.Type}, {"latitude", type number}, {"longitude", type number}, {"message_type", Int64.Type}, {"percent", Int64.Type}, {"tank_size", Int64.Type}, {"efuel.liters", type number}, {"Fuel Event Type", type text}, {"Refilled Liters", Int64.Type}, {"Theft Liters", Int64.Type}, {"extra", type text}}),
    #"Removed Columns" = Table.RemoveColumns(#"Changed Type",{"device_id"}),
    #"Changed Type with Locale" = Table.TransformColumnTypes(#"Removed Columns", {{"edt", type datetime}}, "en-US")
in
    #"Changed Type with Locale"




    XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX



    EDATA


    let
    // ===================================================================
    // PART 0: BLOB STORAGE CONNECTION - CORRECTED
    // ===================================================================
    // Connect to the base URL of your storage account only.
    Source = AzureStorage.Blobs("https://onlineautomationstorage.blob.core.windows.net/"),
    
    // Access the 'rendalli' container's data.
    Container = Source{[Name="karma-regis"]}[Data],
    #"Filtered Rows" = Table.SelectRows(Container, each Text.StartsWith([Name], "edata")),

    // Load and combine content of all JSON files.
    // Each JSON file is expected to contain a list of records (events) as generated by your Python script.
    CombinedContent = Table.AddColumn(#"Filtered Rows", "ParsedContent", each Json.Document([Content])),
    AllEvents = List.Combine(CombinedContent[ParsedContent]), // Combines all lists from all files into a single list
    EventsTable = Table.FromList(AllEvents, Splitter.SplitByNothing(), {"Record"}),
    #"Expanded Record" = Table.ExpandRecordColumn(EventsTable, "Record", {"car_id", "carnumber", "edt_tz", "latitude", "longitude", "parameters"}, {"car_id", "carnumber", "edt_tz", "latitude", "longitude", "parameters"}),
    #"Expanded parameters" = Table.ExpandListColumn(#"Expanded Record", "parameters"),
    #"Expanded parameters1" = Table.ExpandRecordColumn(#"Expanded parameters", "parameters", {"value", "desc"}, {"parameters.value", "parameters.desc"}),
    #"Filtered Rows1" = Table.SelectRows(#"Expanded parameters1", each [parameters.desc] = "Fuel Level (%)" or [parameters.desc] = ""),
    #"Removed Columns" = Table.RemoveColumns(#"Filtered Rows1",{"parameters.desc"}),
    #"Inserted Literal" = Table.AddColumn(#"Removed Columns", "tank_size", each "80"),
    #"Renamed Columns" = Table.RenameColumns(#"Inserted Literal",{{"parameters.value", "percent"}, {"edt_tz", "edt"}}),
    #"Changed Type" = Table.TransformColumnTypes(#"Renamed Columns",{{"car_id", Int64.Type}, {"carnumber", type text}, {"latitude", type number}, {"longitude", type number}, {"percent", Int64.Type}, {"tank_size", Int64.Type}}),
    #"Removed Columns1" = Table.RemoveColumns(#"Changed Type",{"carnumber"})
in
    #"Removed Columns1"SSSSS